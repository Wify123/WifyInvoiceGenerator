<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wify Systems | Quotation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
      @layer base {
        /* Font and base styles */
        body {
          font-family: "Arial", sans-serif;
        }

        .title {
          color: #000;
        }

        .highlight {
          color: #2d89ef;
        }

        .border-gray-pdf {
          border-color: #ddd;
        }
      }
    </style>
  </head>

  <body class="">
    <div
      id="app"
      class="bg-slate-100 min-h-screen flex items-center print:items-start justify-center p-4 print:p-0 text-xs"
    >
      <!-- Login Form -->
      <div
        v-if="!isLoggedIn"
        class="flex items-center justify-center min-h-screen bg-gray-100 px-4"
      >
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm">
          <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
          <form @submit.prevent="login">
            <div class="mb-4">
              <label
                for="username"
                class="block text-sm font-medium text-gray-700"
                >Username</label
              >
              <input
                v-model="username"
                type="text"
                id="username"
                placeholder="Enter Username"
                class="w-full px-4 py-2 mt-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
              />
            </div>
            <div class="mb-6">
              <label
                for="password"
                class="block text-sm font-medium text-gray-700"
                >Password</label
              >
              <input
                v-model="password"
                type="password"
                id="password"
                placeholder="Enter Password"
                class="w-full px-4 py-2 mt-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
              />
            </div>
            <div v-if="error" class="text-red-500 text-sm mb-4">
              <i class="bi bi-exclamation-circle"></i> {{ error }}
            </div>
            <button
              type="submit"
              class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              Login
            </button>
          </form>
        </div>
      </div>

      <!-- form  -->
      <div
        v-if="screen == 'form' && isLoggedIn"
        class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl"
      >
        <div class="mb-4 space-y-2">
          <div class="flex items-center justify-between gap-2">
            <div class="h-12 object-cover">
              <img
                src="./Asset/W.png"
                class="h-9 w-auto scale-150 ml-6"
                alt=""
              />
            </div>
            <h1 class="text-2xl font-bold text-center text-slate-800">
              Quotation Form
            </h1>
            <div class="space-y-2">
              <div class="flex items-center gap-4">
                <p class="text-sm font-medium text-slate-700">Quotation No:</p>
                <p class="text-sm text-gray-500">{{invoice.invoiceNumber}}</p>
              </div>
              <div class="flex items-center gap-4">
                <p class="text-sm font-medium text-slate-700">
                  Quotation Date:
                </p>
                <p class="text-sm text-gray-500">{{formattedInvoiceDate}}</p>
              </div>
            </div>
          </div>

          <hr />
        </div>
        <form @submit.prevent="submitAndPrint" class="space-y-6">
          <div class="grid grid-cols-1 lg:grid-cols-2 print:grid-cols-2 gap-6">
            <div>
              <label
                for="invoiceNumber"
                class="block text-sm font-medium text-slate-700"
                >Quotation No</label
              >
              <input
                v-model="invoice.invoiceNumber"
                type="text"
                id="invoiceNumber"
                name="invoiceNumber"
                required
                disabled
                class="h-8 px-4 w-full rounded-md border border-slate-200 focus:outline outline-blue-500 mt-1 disabled:bg-slate-200 disabled:text-slate-500"
                aria-describedby="invoiceNumberError"
                title="This field is auto-generated and cannot be edited."
              />
              <p
                id="invoiceNumberError"
                class="mt-2 text-sm text-red-600 hidden"
              ></p>
            </div>

            <div>
              <label
                for="invoiceDate"
                class="block text-sm font-medium text-slate-700"
                >Quotation Date</label
              >
              <input
                v-model="invoice.invoiceDate"
                type="date"
                id="invoiceDate"
                name="invoiceDate"
                required
                class="h-8 px-4 w-full rounded-md border border-slate-200 focus:outline outline-blue-500 mt-1"
                :min="minDate"
              />
            </div>

            <div>
              <label
                for="customerName"
                class="block text-sm font-medium text-slate-700"
                >Customer Name</label
              >
              <input
                v-model="invoice.customerName"
                type="text"
                id="customerName"
                name="customerName"
                required
                class="h-8 px-4 w-full rounded-md border border-slate-200 focus:outline outline-blue-500 mt-1"
                aria-describedby="customerNameError"
              />
              <p
                id="customerNameError"
                class="mt-2 text-sm text-red-600 hidden"
              ></p>
            </div>

            <div>
              <label
                for="customerAddress"
                class="block text-sm font-medium text-slate-700"
                >Customer Address</label
              >
              <textarea
                v-model="invoice.customerAddress"
                id="customerAddress"
                name="customerAddress"
                rows="3"
                class="py-2 px-4 w-full rounded-md border border-slate-200 focus:outline outline-blue-500 mt-1"
              ></textarea>
            </div>

            <div>
              <label for="gst" class="block text-sm font-medium text-slate-700"
                >GST No</label
              >
              <input
                v-model="invoice.gst"
                type="text"
                id="gst"
                name="gst"
                required
                class="h-8 px-4 w-full rounded-md border border-slate-200 focus:outline outline-blue-500 mt-1"
                aria-describedby="gstError"
              />
              <p id="gstError" class="mt-2 text-sm text-red-600 hidden"></p>
            </div>

            <div>
              <label
                for="generatedBy"
                class="block text-sm font-medium text-slate-700"
                >Generated By</label
              >
              <input
                v-model="invoice.generatedBy"
                type="text"
                id="generatedBy"
                name="generatedBy"
                required
                class="h-8 px-4 w-full rounded-md border border-slate-200 focus:outline outline-blue-500 mt-1"
                aria-describedby="generatedByError"
              />
              <p
                id="generatedByError"
                class="mt-2 text-sm text-red-600 hidden"
              ></p>
            </div>
          </div>

          <div>
            <h2 class="text-xl font-semibold mb-2">Products</h2>
            <div id="productList" class="space-y-4">
              <div class="overflow-y-auto w-full">
                <table class="mt-4 text-left table-auto w-full">
                  <thead>
                    <tr>
                      <th
                        class="p-4 transition-colors cursor-pointer border-y border-slate-200 bg-slate-50 hover:bg-slate-100"
                      >
                        <p
                          class="flex items-center justify-between gap-2 font-sans text-sm font-normal leading-none text-slate-500"
                        >
                          Product
                        </p>
                      </th>
                      <th
                        class="p-4 transition-colors cursor-pointer border-y border-slate-200 bg-slate-50 hover:bg-slate-100"
                      >
                        <p
                          class="flex items-center justify-between gap-2 font-sans text-sm font-normal leading-none text-slate-500"
                        >
                          Quantity
                        </p>
                      </th>
                      <th
                        class="p-4 transition-colors cursor-pointer border-y border-slate-200 bg-slate-50 hover:bg-slate-100"
                      >
                        <p
                          class="flex items-center justify-between gap-2 font-sans text-sm font-normal leading-none text-slate-500"
                        >
                          Price
                        </p>
                      </th>
                      <th
                        class="p-4 transition-colors cursor-pointer border-y border-slate-200 bg-slate-50 hover:bg-slate-100"
                      >
                        <p
                          class="flex items-center justify-between gap-2 font-sans text-sm font-normal leading-none text-slate-500"
                        >
                          Total
                        </p>
                      </th>
                      <th
                        class="p-4 transition-colors cursor-pointer border-y border-slate-200 bg-slate-50 hover:bg-slate-100"
                      >
                        <p
                          class="flex items-center justify-between gap-2 font-sans text-sm font-normal leading-none text-slate-500"
                        ></p>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      class=""
                      v-for="(product, index) of invoice.products"
                      :key="index"
                    >
                      <td class="p-2 border-b border-slate-200">
                        <select
                          name="product"
                          @change="updateProduct($event, index)"
                          :model="invoice.products[index]"
                          id=""
                          class="px-4 h-8 w-72 rounded-md border border-slate-200 focus:outline outline-blue-500"
                        >
                          <option
                            :value="JSON.stringify(item)"
                            v-for="(item, index) of productList"
                          >
                            {{item.label}}
                          </option>
                        </select>
                      </td>
                      <td class="p-2 border-b border-slate-200">
                        <input
                          name="quantity"
                          @input="validateQuantity"
                          v-model="invoice.products[index].quantity"
                          min="1"
                          type="number"
                          class="px-4 h-8 w-32 rounded-md border border-slate-200 focus:outline outline-blue-500"
                        />
                      </td>
                      <td class="p-2 border-b border-slate-200">
                        <input
                          name="price"
                          v-model="invoice.products[index].price"
                          disabled
                          type="number"
                          class="px-4 h-8 w-32 rounded-md border border-slate-200 focus:outline outline-blue-500 disabled:bg-slate-200 disabled:text-slate-500"
                        />
                      </td>
                      <td class="p-2 border-b border-slate-200">
                        <input
                          disabled
                          name="total"
                          v-model="invoice.products[index].total"
                          type="number"
                          class="px-4 h-8 w-32 rounded-md border border-slate-200 focus:outline outline-blue-500 disabled:bg-slate-200 disabled:text-slate-500"
                        />
                      </td>
                      <td class="p-2 border-b border-slate-200">
                        <span
                          @click="removeProduct(index)"
                          class="cursor-pointer"
                        >
                          <span class=""><i class="bi bi-x-lg"></i></span>
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <button
              @click="addProduct"
              :disabled="!productList.length"
              type="button"
              id="addProduct"
              class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none f"
            >
              Add Product
            </button>
            <p v-if="!productList.length" class="text-red-500">
              No products available to add.
            </p>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label
                for="commission"
                class="block text-sm font-medium text-slate-700"
                >Discount %</label
              >
              <div
                class="mt-1 rounded-md shadow-sm flex items-center gap-2 border border-slate-200 focus-within:outline outline-blue-500 px-2"
                :class="{
                                'border-red-500': invoice.commission < 0 || invoice.commission > 100,
                                'border-slate-200': invoice.commission >= 0 && invoice.commission <= 100
                            }"
              >
                <input
                  v-model="invoice.commission"
                  @input="validateCommission"
                  type="number"
                  name="commission"
                  id="commission"
                  min="0"
                  max="100"
                  class="h-8 rounded-md focus:outline-none w-full"
                  placeholder="Enter discount (0-100)"
                  aria-describedby="commission-currency"
                />
                <span class="text-slate-500" id="commission-currency">%</span>
              </div>
              <p
                v-if="invoice.commission < 0 || invoice.commission > 100"
                class="text-red-500 text-sm mt-1"
              >
                Please enter a discount between 0% and 100%.
              </p>
            </div>
            <div>
              <label
                for="totalAmount"
                class="block text-sm font-medium text-slate-700"
                >Total Amount</label
              >
              <div
                class="mt-1 rounded-md shadow-sm flex items-center gap-2 text-xl font-semibold"
              >
                <span class="text-slate-500">₹</span>
                <span class=""
                  >{{invoice.grandTotalAmount.toLocaleString('en-IN') ||
                  0}}</span
                >
                <span class="text-slate-500">INR</span>
              </div>
            </div>
          </div>

          <div class="flex items-center justify-end gap-2">
            <button
              @click="toggleScreen"
              class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Preview
            </button>
            <button
              @click="submitAndPrint"
              type="submit"
              class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Generate Quotation
            </button>
            <button
              @click="logout"
              class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Logout
            </button>
          </div>
        </form>
      </div>

      <!-- preview  -->
      <div
        v-if="screen == 'preview' && isLoggedIn"
        class="bg-white rounded-lg shadow-xl print:shadow-none p-6 w-full max-w-4xl print:size-full"
      >
        <header class="mb-1 space-y-2">
          <!-- Grid with 3 columns -->
          <div class="grid grid-cols-3 gap-4">
            <!-- Logo Section -->
            <div class="flex justify-start items-center ml-20">
              <img
                src="./Asset/W.png"
                class="h-12 w-auto scale-150"
                alt="Wify Logo"
              />
            </div>

            <!-- Company Details Section -->
            <div class="text-center col-span-1">
              <p class="text-xl font-semibold">Wify Systems Pvt Ltd</p>
              <p class="text-gray-600">Kotwal Nagar Kiwale-412101</p>
              <p class="text-gray-600">
                Phone: <span class="font-medium">7249363944</span>
              </p>
              <p class="text-gray-600">
                Email:
                <a
                  href="mailto:wifysystems@gmail.com"
                  class="highlight underline"
                  >wifysystems@gmail.com</a
                >
              </p>
              <p class="text-gray-600">GSTIN: 27AACCW6139K1ZX</p>
              <p class="text-gray-600">State: Maharashtra</p>
            </div>

            <!-- Quotation Information Section -->
            <div class="flex flex-col items-center justify-center space-y-2">
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div class="col-span-2 text-3xl font-bold title text-center">
                  Quotation
                </div>

                <!-- Row 1 -->
                <div class="col-span-1 text-gray-700 text-left">
                  Quotation No.
                </div>
                <div class="col-span-1 font-semibold text-left">
                  {{invoice.invoiceNumber}}
                </div>

                <!-- Row 2 -->
                <div class="col-span-1 text-gray-700 text-left">
                  Quotation Date:
                </div>
                <div class="col-span-1 font-semibold text-left">
                  {{formattedInvoiceDate}}
                </div>
              </div>
            </div>
          </div>
          <hr class="border-t-4 border-gray-600 w-full" />
        </header>

        <!-- Estimate Details Section -->
        <section class="mb-1 space-y-2">
          <h2 class="text-lg font-bold">Estimate Details</h2>
          <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col space-y-1 text-sm p-1">
              <div class="font-bold text-black">{{invoice.customerName}}</div>
              <div class="text-gray-700">{{invoice.customerAddress}}</div>
            </div>

            <div class="grid grid-cols-4 gap-1 text-sm">
              <div class="col-span-1"></div>
              <div class="col-span-2 text-gray-700 text-left">GST No :</div>
              <div class="col-span-1 font-semibold text-black text-left">
                {{invoice.gst}}
              </div>

              <div class="col-span-1"></div>
              <div class="col-span-2 text-gray-700 text-left">
                Generated By:
              </div>
              <div class="col-span-1 font-semibold text-black text-left">
                {{invoice.generatedBy}}
              </div>

              <div class="col-span-1"></div>
              <div class="col-span-2 text-gray-700 text-left">
                Place of Supply:
              </div>
              <div class="col-span-1 font-semibold text-black text-left">
                Pune
              </div>
            </div>
          </div>
        </section>

        <!-- Items Table -->
        <section id="productList" class="mb-1 space-y-2">
          <table
            class="w-full text-sm text-left border-collapse border border-gray-pdf"
          >
            <thead
              class="bg-gray-200 text-gray-800 uppercase text-xs font-semibold"
            >
              <tr>
                <th class="border border-gray-pdf px-4 py-2 text-center">#</th>
                <th class="border border-gray-pdf px-4 py-2 text-left">
                  Item Name
                </th>
                <th class="border border-gray-pdf px-4 py-2 text-center">
                  HSN Code
                </th>
                <th class="border border-gray-pdf px-4 py-2 text-center">
                  Qty
                </th>
                <th class="border border-gray-pdf px-4 py-2 text-center">
                  Price/Unit
                </th>
                <th class="border border-gray-pdf px-4 py-2 text-center">
                  Amount
                </th>
                <th class="border border-gray-pdf px-4 py-2 text-center">
                  Discount %
                </th>
                <th class="border border-gray-pdf px-4 py-2 text-center">
                  Total Amount
                </th>
              </tr>
            </thead>
            <tbody>
              <tr
                v-for="(product, index) of invoice.products"
                :key="index"
                class="odd:bg-white even:bg-gray-50"
              >
                <td class="border border-gray-pdf px-4 py-2 text-center">
                  {{index + 1}}
                </td>
                <td class="border border-gray-pdf px-4 py-2 text-left">
                  {{ invoice.products[index].label}}
                </td>
                <td class="border border-gray-pdf px-4 py-2 text-center">
                  8536
                </td>
                <td class="border border-gray-pdf px-4 py-2 text-center">
                  {{ invoice.products[index].quantity}}
                </td>
                <td class="border border-gray-pdf px-4 py-2 text-center">
                  {{ invoice.products[index].price}}
                </td>
                <td class="border border-gray-pdf px-4 py-2 text-center">
                  {{ invoice.products[index].total}}
                </td>
                <td class="border border-gray-pdf px-4 py-2 text-center">
                  {{invoice.commission}}
                </td>
                <td class="border border-gray-pdf px-4 py-2 text-center">
                  {{(invoice.products[index].total * (1 -
                  (invoice.commission/100))).toFixed(2)}}
                </td>
              </tr>
            </tbody>
          </table>
        </section>

        <!-- Summary Section -->
        <section class="mb-1 space-y-2">
          <div class="grid grid-cols-8 gap-1 text-sm mb-1">
            <!-- Row 1 -->
            <div class="col-span-5"></div>
            <div class="col-span-2 text-gray-700 text-left">Total Amount</div>
            <div class="col-span-1 font-semibold text-black text-right mr-4">
              ₹ {{invoice.totalAmount.toLocaleString('en-IN')}}
            </div>

            <!-- Row 2 -->
            <div class="col-span-5"></div>
            <div class="col-span-2 text-gray-700 text-left">Total Discount</div>
            <div class="col-span-1 font-semibold text-black text-right mr-4">
              ₹ {{invoice.totalDiscount.toLocaleString('en-IN')}}
            </div>

            <!-- Row 3 -->
            <div class="col-span-5"></div>
            <div class="col-span-2 text-gray-700 text-left">Grand Total</div>
            <div class="col-span-1 font-semibold text-black text-right mr-4">
              ₹ {{invoice.grandTotalAmount.toLocaleString('en-IN')}}
            </div>
          </div>
          <hr class="border-t-4 border-gray-600 w-full hidden print:block" />
        </section>

        <footer class="hidden print:block">
          <!-- Bank Details and Terms Section -->
          <section class="mb-1 space-y-2">
            <div class="grid grid-cols-2 gap-6">
              <!-- Bank Details -->
              <div class="flex flex-col space-y-1 text-sm">
                <h2 class="text-lg font-bold mb-3">Bank Details</h2>
                <div class="grid grid-cols-3">
                  <div class="col-span-1 text-gray-700">Name:</div>
                  <div class="col-span-2 font-semibold">HDFC Bank</div>
                  <div class="col-span-1 text-gray-700">Account No.:</div>
                  <div class="col-span-2 font-semibold">50200053375703</div>
                  <div class="col-span-1 text-gray-700">IFSC Code:</div>
                  <div class="col-span-2 font-semibold">HDFC0009606</div>
                  <div class="col-span-1 text-gray-700">Branch:</div>
                  <div class="col-span-2 font-semibold">Ravet</div>
                  <div class="col-span-1 text-gray-700">Account Holder:</div>
                  <div class="col-span-2 font-semibold">
                    Wify Systems Pvt Ltd
                  </div>
                </div>
              </div>

              <!-- Terms and Conditions -->
              <div>
                <h2 class="text-lg font-bold mb-3">Terms and Conditions</h2>
                <ul class="list-disc list-inside text-gray-700">
                  <li>
                    Quotation Validity: Valid for 14 days from the issue date.
                  </li>
                  <li>
                    Installation: Requires a stable internet connection on-site.
                  </li>
                  <li>Warranty: 2 years on manufacturing defects only.</li>
                  <li>
                    Civil/Carpentry Work: Customer's responsibility and cost.
                  </li>
                  <li>
                    Material: Only our supplied materials will be installed.
                  </li>
                  <li>GST: Applicable as per current rates.</li>
                  <li>
                    Payment Terms:
                    <ul class="list-disc list-inside ml-6">
                      <li>50% to confirm the order.</li>
                      <li>40% before installation.</li>
                      <li>10% after installation.</li>
                    </ul>
                  </li>
                  <li>
                    Late Payments: 12% interest per annum on overdue payments.
                  </li>
                  <li>
                    Cancellation: 10% of advance retained for cancellations.
                  </li>
                </ul>
              </div>
            </div>
          </section>

          <section class="mb-1 space-y-2">
            <h2 class="text-lg font-bold mb-3">Declaration</h2>
            <p class="text-gray-700">
              We hereby confirm that the prices, terms, and conditions outlined
              in this quotation are accurate and binding, based on the current
              scope of work and materials specified. Any changes to the scope,
              materials, or conditions may result in a revision of the quoted
              price.
            </p>
            <p class="text-gray-700 mt-2">
              By accepting this quotation, the client agrees to the terms and
              conditions specified herein, including payment schedules,
              installation requirements, and warranties. The client acknowledges
              that they have read, understood, and accepted these terms.
            </p>
          </section>

          <section class="text-center text-sm text-gray-500 mt-6">
            Subject to Pune Jurisdiction.
          </section>
        </footer>

        <div class="print:hidden flex items-center justify-end gap-2">
          <button
            @click="toggleScreen"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            Edit
          </button>
          <button
            @click="submitAndPrint"
            type="submit"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            Generate Quotation
          </button>
        </div>
      </div>

      <!-- loading -->
      <div
        v-if="loading && isLoggedIn"
        class="fixed inset-0 bg-black/20 flex items-center justify-center"
      >
        <div
          class="w-72 p-12 rounded-lg bg-white flex items-center justify-center"
        >
          <div class="flex items-center gap-2">
            <span class="animate-spin text-lg">
              <i class="bi bi-arrow-repeat"></i>
            </span>
            <h2 class="text-xl font-semibold text-center animate-pulse">
              Loading...
            </h2>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      const app = Vue.createApp({
        data() {
          return {
            isLoggedIn: false,
            username: "",
            password: "",
            productList: [],
            loading: false,
            error: null,
            invoice: {
              invoiceNumber: "",
              customerName: "",
              invoiceDate: "",
              customerAddress: "",
              products: [],
              totalAmount: 0,
              gst: "",
              commission: 0,
              totalDiscount: 0,
              grandTotalAmount: 0,
              generatedBy: "",
            },
            minDate: moment().format("YYYY-MM-DD"),
            screen: "form",
          };
        },

        created() {
          this.checkSession();
        },

        methods: {
          async getProductsData() {
            this.loading = true;
            console.log("loading is working...");
            this.error = null;
            try {
              const res = await fetch(
                "https://wifyapi.vercel.app/getProductsPrice"
              );
              let responce = await res.json();
              this.productList = responce.data;
              localStorage.setItem(
                "productList",
                JSON.stringify({ productList: this.productList })
              );
              if (!this.productList.length) {
                this.error = "No products available. Please try again later.";
              }
            } catch (error) {
              console.error("Error fetching products data:", error);
              this.error = "Failed to load product data.";
            } finally {
              this.loading = false;
            }
          },

          async getInvoiceNumber() {
            this.error = null;
            try {
              console.log("Fetching new invoice number...");
              const res = await fetch(
                "https://wifyapi.vercel.app/getInvoiceNumber"
              );
              let responce = await res.json();
              this.invoice.invoiceNumber = responce.newInvoice;
            } catch (error) {
              console.error("Error fetching invoice number:", error);
              this.error =
                "Unable to generate invoice number. Please reload the page.";
            }
          },

          addProduct() {
            if (this.productList.length > 0) {
              this.invoice.products.push({
                value: this.productList[0].value,
                label: this.productList[0].label,
                price: this.productList[0].mrp,
                quantity: 1,
                total: this.productList[0].mrp,
              });
            } else {
              this.error = "No products available to add.";
            }
          },

          removeProduct(index) {
            this.invoice.products.splice(index, 1);
          },

          updateProduct(event, index) {
            const selectedProduct = JSON.parse(event.target.value);
            const { label, value, mrp } = selectedProduct;
            this.invoice.products[index] = {
              ...this.invoice.products[index],
              label,
              value,
              price: mrp,
            };
          },

          calculateProductTotal(product) {
            product.total = (product.quantity * product.price).toFixed(2);
          },

          calculateInvoiceTotal() {
            const total = this.invoice.products.reduce(
              (sum, product) => sum + product.quantity * product.price,
              0
            );
            this.invoice.totalAmount = total;
          },

          validateCommission() {
            if (this.invoice.commission < 0) {
              this.invoice.commission = 0;
            } else if (this.invoice.commission > 100) {
              this.invoice.commission = 100;
            }
          },

          validateQuantity() {
            this.invoice.products.forEach((product) => {
              if (product.quantity <= 0) {
                product.quantity = 1;
              }
            });
          },

          setInvoiceDateToToday() {
            if (!this.invoice.invoiceDate) {
              this.invoice.invoiceDate = moment().format("YYYY-MM-DD");
            }
          },

          async submitAndPrint(event) {
            try {
              if (
                !this.invoice.customerName ||
                !this.invoice.products.length ||
                !this.invoice.generatedBy ||
                !this.invoice.customerAddress
              ) {
                alert(
                  "Please fill all required fields and add at least one product."
                );
                this.toggleScreen();
                return;
              }
              const session = localStorage.getItem("session");
              const sessionData = JSON.parse(session);
              const user = sessionData.username;

              fetch("https://wifyapi.vercel.app/submitInvoice", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  username: user,
                  invoice: this.invoice,
                }),
              })
                .then((response) => {
                  if (!response.ok) {
                    alert("Form submission failed. Please try again.");
                    throw new Error(`HTTP error! Status: ${response.status}`);
                  }
                  return response.json();
                })
                .then((data) => {
                  console.log("Invoice submitted successfully:", data);
                });

              alert("Form submitted successfully!");

              this.print();
            } catch (error) {
              console.error("Error during form submission:", error);
              alert("An error occurred: " + error.message);
            }
          },

          print() {
            window.onafterprint = function () {
              window.location.href = '/';
            };
            this.screen = "preview";
            document.title = ` Wify Systems | Quotation-${this.invoice.invoiceNumber}`;
            setTimeout(() => {
              window.print();
            }, 0);
          },

          toggleScreen() {
            this.screen = this.screen === "form" ? "preview" : "form";
          },

          async login() {
            const res = await fetch("https://wifyapi.vercel.app/auth", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                username: this.username,
                password: this.password,
              }),
            });

            let responce = await res.json();

            if (responce.status == "success") {
              const expiry = responce.expiry;
              localStorage.setItem(
                "session",
                JSON.stringify({ username: this.username, expiry })
              );
              this.isLoggedIn = true;
              this.getInvoiceNumber();
              this.getProductsData();
              this.setInvoiceDateToToday();
              this.error = null;
            } else {
              this.error = responce.message;
            }
          },

          logout() {
            localStorage.removeItem("session");
            localStorage.removeItem("productList");
            this.isLoggedIn = false;
          },

          checkSession() {
            const session = localStorage.getItem("session");
            if (session) {
              const sessionData = JSON.parse(session);
              const now = new Date().getTime();
              if (now < sessionData.expiry) {
                this.isLoggedIn = true;
              } else {
                this.logout();
              }
            }
          },
        },

        mounted() {
          this.checkSession();

          if (this.isLoggedIn) {
            this.getInvoiceNumber();
            const check = localStorage.getItem("productList");
            if (check) {
              const productList = JSON.parse(check);
              this.productList = productList.productList;
            } else {
              this.getProductsData();
            }
            this.setInvoiceDateToToday();
          }
        },

        computed: {
          formattedInvoiceDate() {
            return this.invoice.invoiceDate
              ? moment(this.invoice.invoiceDate, "YYYY-MM-DD").format(
                  "D MMM, YYYY"
                )
              : "";
          },

          totalInvoiceAmount() {
            return this.invoice.products.reduce(
              (sum, product) => sum + product.quantity * product.price,
              0
            );
          },
        },

        watch: {
          invoice: {
            deep: true,
            handler() {
              this.invoice.products.forEach((product) =>
                this.calculateProductTotal(product)
              );
              this.invoice.totalAmount = this.totalInvoiceAmount.toFixed(2);
              this.invoice.totalDiscount = (
                this.invoice.totalAmount -
                this.invoice.totalAmount * (1 - this.invoice.commission / 100)
              ).toFixed(2);
              this.invoice.grandTotalAmount = (
                this.invoice.totalAmount - this.invoice.totalDiscount
              ).toFixed(2);
            },
          },

          "invoice.invoiceDate"(newDate) {
            if (!newDate) {
              this.setInvoiceDateToToday();
            }
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
